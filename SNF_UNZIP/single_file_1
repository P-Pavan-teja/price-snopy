CREATE OR REPLACE FUNCTION COMMON_DB.UTIL_SCH.UNZIP_FILE(stage_name STRING, rel_path STRING)
RETURNS TABLE (csv_row STRING)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python')
HANDLER = 'UnzipFile'
AS
$$
import zipfile, io
from snowflake.snowpark.files import SnowflakeFile

class UnzipFile:
    def process(self, stage_name: str, rel_path: str):
        full_path = f"@{stage_name.strip('@')}/{rel_path.lstrip('/')}"
        with SnowflakeFile.open(full_path, 'rb') as f:
            zip_bytes = f.read()

        with zipfile.ZipFile(io.BytesIO(zip_bytes)) as zf:
            for info in zf.infolist():
                if info.is_dir():
                    continue
                with zf.open(info.filename) as fh:
                    raw = fh.read()
                    for enc in ('utf-8','latin-1','cp1252','iso-8859-1'):
                        try:
                            content = raw.decode(enc)
                            break
                        except UnicodeDecodeError:
                            continue
                    for line in content.splitlines():
                        line = line.strip()
                        if line and not line.startswith('Mac OS') and 'ATTR' not in line:
                            yield (line,)
$$;

-- call it like:
SELECT csv_row
FROM TABLE(
  COMMON_DB.UTIL_SCH.UNZIP_FILE(
    'COMMON_DB.UTIL_SCH.MY_S3_EXTERNAL_STAGE',
    'zipfiles/srcfiles/Department1.zip'
  )
);
