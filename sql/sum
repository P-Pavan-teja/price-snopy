/* ================================================
   DAY_PARAM = Dashboard reference day (today = 20)
   DAY_OF_EMAIL = Actual business schedule day per file

   Rules:
   ======
   Show a row ONLY IF:
   1) ARRIVED TODAY  → Success
   2) (DAY_PARAM = DAY_OF_EMAIL) AND NOT ARRIVED → Failed
   Everything else → NO ROW
   ================================================ */

WITH PARAM AS (
  SELECT 20::NUMBER AS DAY_PARAM   -- Hard coded today for testing
),

RAW AS (
  SELECT r.*
  FROM TABLE(RESULT_SCAN('01c009be-0003-c2f4-0005-64d202f2f296')) r
  WHERE r.LOAD_DATE IS NOT NULL
    AND UPPER(r.SOURCE_FREQ) = 'MONTHLY'
),

FLAGS AS (
  SELECT
      r.*,
      p.DAY_PARAM,
      DAY_OF_EMAIL::NUMBER AS SCHED_DAY,       -- business expected day
      DAY(CURRENT_DATE()) AS TODAY_DAY,
      /* Did we receive file in last 24h? */
      (FILE_ENDTIME_EST >= DATEADD(HOUR, -24, CURRENT_TIMESTAMP())) AS ARRIVED_TODAY
  FROM RAW r
  CROSS JOIN PARAM p
)

SELECT
    CURRENT_DATE() AS LOAD_DATE,        -- always show today's row

    SOURCE_FREQ,
    LOAD_DATA_CATEGORY,

    /* Only show actual values when Success */
    IFF(ARRIVED_TODAY, ACCOUNTING_DATE, NULL) AS ACCOUNTING_DATE,
    IFF(ARRIVED_TODAY, SOURCE_FILE_NAME, '**') AS SOURCE_FILE_NAME,
    IFF(ARRIVED_TODAY, TARGET_NAME, '**') AS TARGET_NAME,
    IFF(ARRIVED_TODAY, SOURCE_RECORDS, 0) AS SOURCE_RECORDS,
    IFF(ARRIVED_TODAY, TARGET_RECORDS, 0) AS TARGET_RECORDS,

    /* Status logic */
    IFF(ARRIVED_TODAY, 'Success', 'Failed') AS LOAD_STATUS,

    /* Error message only for Failed */
    IFF(ARRIVED_TODAY, '', 'Source file is missing.') AS ERROR_MESSAGE,

    /* Show business day always */
    SCHED_DAY AS DAY_OF_EMAIL,

    ETL_INSERT_TIMESTAMP,

    /* Only show when Success */
    IFF(ARRIVED_TODAY, FILE_ENDTIME_EST, NULL) AS FILE_ENDTIME_EST

FROM FLAGS

WHERE
    /* ✅ Success logic */
    ARRIVED_TODAY

    OR
    /* ✅ Missing logic only when FILE EXPECTED TODAY */
    (DAY_PARAM = SCHED_DAY AND NOT ARRIVED_TODAY)

ORDER BY SOURCE_FILE_NAME;
