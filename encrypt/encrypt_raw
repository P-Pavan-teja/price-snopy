SELECT 
    c.C_CUSTKEY,
    c.C_NAME,
    o.O_ORDERKEY,
    o.O_ORDERDATE
FROM SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.CUSTOMER c
JOIN SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.ORDERS o
    ON c.C_CUSTKEY = o.O_CUSTKEY
WHERE c.C_CUSTKEY < 100
ORDER BY c.C_CUSTKEY
LIMIT 100;

CREATE OR REPLACE SECRET COMMON_DB.UTIL_SCH.ENC_KEY_SECRET
  TYPE = GENERIC_STRING
  SECRET_STRING = 'PAVAN TEJA';

CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION ENC_KEY_INT
  ALLOWED_AUTHENTICATION_SECRETS = (COMMON_DB.UTIL_SCH.ENC_KEY_SECRET)
  ALLOWED_NETWORK_RULES = ()
  ENABLED = TRUE;

CREATE OR REPLACE NETWORK RULE ADMIN_ACT.UTIL_SCH.ENC_DUMMY_RULE
  MODE = EGRESS
  TYPE = HOST_PORT
  VALUE_LIST = ('example.com:443');

use role accountadmin;

CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION ENC_KEY_INT
  ALLOWED_NETWORK_RULES = (ADMIN_ACT.UTIL_SCH.ENC_DUMMY_RULE)
  ALLOWED_AUTHENTICATION_SECRETS = (COMMON_DB.UTIL_SCH.ENC_KEY_SECRET)
  ENABLED = TRUE;

SHOW EXTERNAL ACCESS INTEGRATIONS;

CREATE OR REPLACE FUNCTION COMMON_DB.UTIL_SCH.GET_ENC_KEY()
RETURNS BINARY
LANGUAGE PYTHON
RUNTIME_VERSION = 3.10
HANDLER = 'get_key'
EXTERNAL_ACCESS_INTEGRATIONS = (ENC_KEY_INT)
SECRETS = ('enc' = COMMON_DB.UTIL_SCH.ENC_KEY_SECRET)
AS
$$
import _snowflake
import hashlib

def get_key():
    raw = _snowflake.get_generic_secret_string('enc')
    return hashlib.sha256(raw.encode('utf-8')).digest()
$$;


CREATE OR REPLACE TABLE COMMON_DB.UTIL_SCH.CUSTOMER_DEMO AS
SELECT *
FROM SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.CUSTOMER
ORDER BY C_CUSTKEY
LIMIT 100;



CREATE OR REPLACE TABLE COMMON_DB.UTIL_SCH.ORDERS_DEMO AS
SELECT *
FROM SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.ORDERS o
WHERE o.O_CUSTKEY IN (
    SELECT C_CUSTKEY
    FROM COMMON_DB.UTIL_SCH.CUSTOMER_DEMO
)
ORDER BY O_ORDERKEY
LIMIT 100;

SELECT
    c.C_CUSTKEY,
    c.C_NAME,
    o.O_ORDERKEY,
    o.O_ORDERDATE,
    o.O_TOTALPRICE
FROM COMMON_DB.UTIL_SCH.CUSTOMER_DEMO c
JOIN COMMON_DB.UTIL_SCH.ORDERS_DEMO o
    ON c.C_CUSTKEY = o.O_CUSTKEY
ORDER BY c.C_CUSTKEY, o.O_ORDERKEY
LIMIT 50;

ENCRYPT_RAW(
    value_to_encrypt,
    key,
    iv,
    aad,
    mode
)

-- 1) Prepare key and IV (both BINARY)
WITH keys AS (
  SELECT
    SHA2_BINARY('MyKey123!', 256)                            AS key,  -- 32-byte AES-256 key (BINARY)
    TO_BINARY('fixed_iv_16bytes', 'UTF-8')                   AS iv    -- 16 bytes (128 bits) IV
)

-- 2) Deterministic encryption with ENCRYPT_RAW
SELECT
  ENCRYPT_RAW(
      TO_BINARY('ABC', 'UTF-8'),                             -- value_to_encrypt (BINARY)
      key,                                                   -- BINARY key
      iv,                                                    -- BINARY IV (fixed)
      NULL,                                                  -- AAD = NULL (no AAD for CBC)
      'aes-cbc/pad:pkcs'                                     -- encryption method
  ) AS ciph
FROM keys;

CREATE OR REPLACE TABLE COMMON_DB.UTIL_SCH.ENCRYPT_COLUMN_META_DATA AS
SELECT 'C_CUSTKEY' AS COLUMN_NAME, '5678987656789987' AS COLUMN_IV_KEY;

create or replace TABLE COMMON_DB.UTIL_SCH.ENCRYPT_COLUMN_META_DATA (
	COLUMN_NAME VARCHAR(9),
	COLUMN_IV_KEY VARCHAR(16)
);

INSERT INTO COMMON_DB.UTIL_SCH.ENCRYPT_COLUMN_META_DATA VALUES
('C_CUSTKEY', '5678987656789987'),
('C_PHONE',   '1234567890123456'),
('C_EMAIL',   'email_iv_16bytes');

CREATE OR REPLACE FUNCTION COMMON_DB.UTIL_SCH.ENCRYPT_VALUE_BY_COLUMN(
    value_to_encrypt STRING,
    column_name STRING
)
RETURNS VARCHAR
LANGUAGE SQL
AS
$$
    ENCRYPT_RAW(
        TO_BINARY(value_to_encrypt, 'UTF-8'),
        SHA2_BINARY('PAVAN TEJA', 256),
        TO_BINARY(
            (
                SELECT COLUMN_IV_KEY
                FROM COMMON_DB.UTIL_SCH.ENCRYPT_COLUMN_META_DATA
                WHERE COLUMN_NAME = column_name
                LIMIT 1                           
            ),
            'UTF-8'
        ),
        NULL,
        'aes-cbc/pad:pkcs'
    ):ciphertext::VARCHAR
$$;


SELECT 
COMMON_DB.UTIL_SCH.ENCRYPT_VALUE_BY_COLUMN(C_CUSTKEY,'C_CUSTKEY') AS C_CUSTKEY_MASKED,
C_CUSTKEY,

C_NAME, C_ADDRESS, C_NATIONKEY, C_PHONE, C_ACCTBAL, C_MKTSEGMENT, C_COMMENT

FROM COMMON_DB.UTIL_SCH.CUSTOMER_DEMO;
